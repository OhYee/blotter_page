{"ast":null,"code":"import { jsx as _jsx } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React from 'react';\nimport Head from 'next/head';\nimport Router, { withRouter } from 'next/router';\n\nconst MD = require('markdown-it')({\n  html: true,\n  linkify: true,\n  breaks: true\n}).use(require('@zombie110year/markdown-it-katex')).use(require('markdown-it-deflist')).use(require('markdown-it-footnote')).use(require('markdown-it-named-headers')).use(require('markdown-it-highlightjs')).use(require('md-it-mermaid'));\n\nimport Button from '@/components/button';\nimport Card from '@/components/card';\nimport Input, { DatePicker, InputNumber, TextArea } from '@/components/input';\nimport { Flex } from '@/components/container';\nimport { message } from '@/components/notification';\nimport Popover from '@/components/popover';\nimport { Loading, Success, Plus } from '@/components/svg';\nimport TagSearch from '@/components/tag_search';\nimport PostContent from '@/components/post_content';\nimport Anchor from '@/components/anchor';\nimport importImages from './images';\nimport RenderEditor from './editor';\nimport RenderFixedButton from './buttons';\nimport ShowNotification from '@/utils/notification';\nimport { Context } from '@/utils/global';\nimport { waitUntil } from '@/utils/debounce';\nimport { markdown, adminPost, postEdit } from '@/utils/api';\nimport { setLocalStorage, getLocalStorage, removeLocalStorage } from '@/utils/storage';\nimport styles from './post.module.scss';\n\nclass PostEdit extends React.Component {\n  //   ws: WebSocket;\n  constructor(props) {\n    super(props);\n\n    _defineProperty(this, \"previewRef\", /*#__PURE__*/React.createRef());\n\n    _defineProperty(this, \"editor\", void 0);\n\n    _defineProperty(this, \"initial\", (url, first) => {\n      this.setState({\n        loading: true\n      });\n      adminPost(url).then(r => {\n        const post = _objectSpread(_objectSpread({}, r), {}, {\n          edit_time: first ? new Date().getTime() : r.edit_time * 1000,\n          publish_time: r.publish_time * 1000\n        });\n\n        this.setState(state => _objectSpread(_objectSpread({}, state), post), () => {\n          if (!!this.editor) this.editor.setValue(r.raw);\n        });\n      }).finally(() => this.setState({\n        loading: false\n      }));\n    });\n\n    _defineProperty(this, \"renderMarkdown\", async source => {\n      this.setState({\n        loading: true\n      });\n      var r = {\n        html: ''\n      };\n\n      try {\n        if (this.state.backRender) r = await markdown(source);else r.html = MD.render(source); // 当没有中文时，words 返回的是 null，需要使用 || 设置默认值 []\n\n        const words = r.html.replace(/<[^>]+>|\\s/g, '').match(/[\\u007f-\\uffff]/g) || [];\n        this.setState({\n          content: r.html,\n          length: words.length\n        });\n      } catch (e) {\n        r = {\n          html: ''\n        };\n        console.error(e);\n      }\n\n      this.setState({\n        loading: false\n      });\n    });\n\n    _defineProperty(this, \"onChange\", value => {\n      waitUntil('post_edit_sync', () => {\n        setLocalStorage(`post-${this.props.router.query.url}`, value);\n\n        if (this.state.preview) {\n          new Promise(() => this.renderMarkdown(value));\n        }\n      }, 2000);\n    });\n\n    _defineProperty(this, \"tagOnAdd\", tag => {\n      this.setState(state => ({\n        tags: [...state.tags].filter(_tag => _tag.short !== tag.short).concat(tag)\n      }));\n    });\n\n    _defineProperty(this, \"tagOnDelete\", tag => {\n      this.setState(state => {\n        var tags = state.tags.filter(_tag => _tag.short != tag.short);\n        return {\n          tags\n        };\n      });\n    });\n\n    _defineProperty(this, \"getPostAll\", () => {\n      const post = {\n        id: this.state.id,\n        title: this.state.title,\n        url: this.state.url,\n        keywords: this.state.keywords,\n        status: this.state.status,\n        abstract: this.state.abstract,\n        view: this.state.view,\n        head_image: this.state.head_image,\n        tags: this.state.tags,\n        publish_time: parseInt(`${this.state.publish_time / 1000}`),\n        edit_time: parseInt(`${this.state.edit_time / 1000}`),\n        raw: this.state.raw,\n        images: this.state.images,\n        content: this.state.content,\n        length: this.state.length\n      };\n      return post;\n    });\n\n    _defineProperty(this, \"submit\", async () => {\n      this.setState({\n        submitDisabled: true\n      });\n\n      try {\n        const post = this.getPostAll();\n        delete post.content;\n        console.log(post);\n        postEdit(post).then(r => {\n          if (ShowNotification(r)) {\n            Router.push(`/admin/post?url=${post.url}`);\n            this.initial(post.url, false);\n            removeLocalStorage(`post-${this.props.router.query.url}`);\n          }\n        }).finally(() => {\n          this.setState({\n            submitDisabled: false\n          });\n        });\n      } catch (e) {\n        const err = e.errorFields.map(item => item.errors.join(' ')).join('\\n');\n        message({\n          alertType: 'error',\n          title: '信息错误',\n          content: err\n        });\n        this.setState({\n          submitDisabled: false\n        });\n      }\n    });\n\n    _defineProperty(this, \"onScroll\", (scrollTop, scrollHeight) => {\n      if (this.state.preview === 2 && !!this.previewRef.current) {\n        this.previewRef.current.scrollTop = scrollTop / scrollHeight * this.previewRef.current.scrollHeight + this.state.offset;\n      }\n    });\n\n    _defineProperty(this, \"renderPreview\", () => {\n      const post = this.getPostAll();\n      return /*#__PURE__*/_jsxs(Card, {\n        neumorphism: true,\n        style: {\n          position: 'relative',\n          overflow: 'hidden'\n        },\n        children: [/*#__PURE__*/_jsx(Anchor, {\n          style: {\n            position: 'absolute'\n          },\n          container: this.previewRef.current,\n          content: post.content\n        }), /*#__PURE__*/_jsxs(\"div\", {\n          className: styles.preview,\n          ref: this.previewRef,\n          children: [this.state.loading ? /*#__PURE__*/_jsx(Loading, {}) : /*#__PURE__*/_jsx(Success, {}), /*#__PURE__*/_jsx(PostContent, {\n            post: post\n          }), this.state.preview === 2 ? /*#__PURE__*/_jsx(\"div\", {\n            style: {\n              height: 'calc(100vh - 20px)'\n            }\n          }) : null]\n        })]\n      });\n    });\n\n    _defineProperty(this, \"renderToolbar\", () => {\n      return /*#__PURE__*/_jsxs(Flex, {\n        direction: \"TB\",\n        fullWidth: true,\n        children: [/*#__PURE__*/_jsx(Input, {\n          label: \"\\u6587\\u7AE0ID\",\n          disabled: true,\n          placeholder: \"\\u6587\\u7AE0ID\",\n          prefix: \"ID\",\n          value: this.state.id,\n          onChange: id => this.setState({\n            id\n          }),\n          style: {\n            width: '100%'\n          }\n        }), /*#__PURE__*/_jsxs(Flex, {\n          mainSize: \"middle\",\n          subSize: \"middle\",\n          children: [/*#__PURE__*/_jsx(Input, {\n            label: \"\\u6587\\u7AE0\\u94FE\\u63A5\",\n            placeholder: \"\\u6587\\u7AE0\\u94FE\\u63A5\",\n            prefix: \"/post/\",\n            value: this.state.url // 限制只允许小写 url\n            ,\n            onChange: url => this.setState({\n              url: !!url ? url.toLowerCase() : url\n            })\n          }), /*#__PURE__*/_jsx(InputNumber, {\n            label: \"\\u9605\\u8BFB\\u91CF\",\n            placeholder: \"\\u9605\\u8BFB\\u91CF\",\n            min: 0,\n            value: this.state.view,\n            onChange: view => this.setState({\n              view\n            })\n          }), /*#__PURE__*/_jsx(DatePicker, {\n            label: \"\\u53D1\\u5E03\\u65F6\\u95F4\",\n            placeholder: \"\\u53D1\\u5E03\\u65F6\\u95F4\",\n            value: this.state.publish_time,\n            onChange: publish_time => this.setState({\n              publish_time\n            })\n          }), /*#__PURE__*/_jsx(DatePicker, {\n            label: \"\\u7F16\\u8F91\\u65F6\\u95F4\",\n            placeholder: \"\\u7F16\\u8F91\\u65F6\\u95F4\",\n            value: this.state.edit_time,\n            onChange: edit_time => this.setState({\n              edit_time\n            })\n          }), /*#__PURE__*/_jsx(Input, {\n            label: \"\\u6587\\u7AE0\\u6807\\u9898\",\n            placeholder: \"\\u6587\\u7AE0\\u6807\\u9898\",\n            value: this.state.title,\n            onChange: title => this.setState({\n              title\n            })\n          }), /*#__PURE__*/_jsx(Input, {\n            label: \"\\u5934\\u56FE\",\n            placeholder: \"\\u5934\\u56FE\",\n            value: this.state.head_image,\n            onChange: head_image => this.setState({\n              head_image\n            })\n          }), /*#__PURE__*/_jsx(Button.Group, {\n            selected: this.state.status,\n            buttons: [{\n              key: '草稿',\n              value: 0\n            }, {\n              key: '隐藏',\n              value: 1\n            }, {\n              key: '发布',\n              value: 2\n            }],\n            onClick: (key, value) => {\n              this.setState({\n                status: value\n              });\n            }\n          }), /*#__PURE__*/_jsx(Button, {\n            neumorphism: true,\n            onClick: () => {\n              this.editor.setValue(this.state.draft);\n            },\n            children: \"\\u6587\\u7AE0\\u6062\\u590D\"\n          }), /*#__PURE__*/_jsx(InputNumber, {\n            label: \"\\u5B57\\u4F53\\u5927\\u5C0F\",\n            value: this.state.fontSize,\n            onChange: fontSize => this.setState({\n              fontSize\n            })\n          }), /*#__PURE__*/_jsx(Button, {\n            neumorphism: true,\n            onClick: () => {\n              const now = new Date().getTime();\n              this.setState({\n                publish_time: now,\n                edit_time: now\n              });\n            },\n            children: \"\\u91CD\\u7F6E\\u65E5\\u671F\"\n          }), /*#__PURE__*/_jsx(Button, {\n            neumorphism: true,\n            onClick: async () => {\n              await this.renderMarkdown(this.state.raw);\n              this.setState({\n                images: importImages(this.state.content)\n              });\n            },\n            children: \"\\u5BFC\\u5165\\u56FE\\u7247\"\n          })]\n        }), /*#__PURE__*/_jsx(TagSearch, {\n          onAdd: this.tagOnAdd,\n          onDelete: this.tagOnDelete,\n          tags: this.state.tags\n        }), /*#__PURE__*/_jsx(TextArea, {\n          label: \"\\u6587\\u7AE0\\u6458\\u8981\",\n          rows: 5,\n          spellCheck: \"false\",\n          placeholder: \"\\u6587\\u7AE0\\u6458\\u8981\",\n          value: this.state.abstract,\n          onChange: abstract => this.setState({\n            abstract\n          })\n        }), /*#__PURE__*/_jsx(Flex, {\n          direction: \"TB\",\n          subAxis: \"flex-end\",\n          fullWidth: true,\n          wrap: false,\n          style: {\n            maxHeight: '50vh',\n            overflow: 'auto'\n          },\n          children: !!this.state.images && this.state.images.map((image, idx) => /*#__PURE__*/_jsxs(Flex, {\n            wrap: false,\n            children: [/*#__PURE__*/_jsx(Flex.Item, {\n              style: {\n                flex: '0 0 3em'\n              },\n              children: /*#__PURE__*/_jsx(\"strong\", {\n                children: idx\n              })\n            }), /*#__PURE__*/_jsx(Flex.Item, {\n              style: {\n                flex: '0 0 auto'\n              },\n              children: /*#__PURE__*/_jsx(Popover, {\n                card: true,\n                shadow: true,\n                trigger: ['click'],\n                component: /*#__PURE__*/_jsx(Card, {\n                  children: /*#__PURE__*/_jsxs(Flex, {\n                    children: [\"\\u786E\\u8BA4\\u5220\\u9664\\uFF1F\", /*#__PURE__*/_jsx(Button, {\n                      primary: true,\n                      neumorphism: true,\n                      onClick: () => this.setState(state => ({\n                        images: state.images.filter((_, idx2) => idx != idx2)\n                      })),\n                      children: \"\\u5220\\u9664\"\n                    })]\n                  })\n                }),\n                children: /*#__PURE__*/_jsx(Button, {\n                  danger: true,\n                  neumorphism: true,\n                  children: \"\\u5220\\u9664\"\n                })\n              })\n            }), /*#__PURE__*/_jsx(Flex.Item, {\n              style: {\n                flex: '1 1 auto'\n              },\n              children: /*#__PURE__*/_jsx(Input, {\n                value: image,\n                onChange: value => {\n                  this.setState(state => {\n                    var {\n                      images\n                    } = state;\n                    images[idx] = value;\n                    return {\n                      images\n                    };\n                  });\n                }\n              })\n            }), /*#__PURE__*/_jsx(Flex.Item, {\n              style: {\n                flex: '0 0 auto'\n              },\n              children: /*#__PURE__*/_jsx(\"img\", {\n                src: image,\n                style: {\n                  maxHeight: '100px'\n                }\n              })\n            })]\n          }, idx))\n        }), /*#__PURE__*/_jsx(Flex.Item, {\n          style: {\n            textAlign: 'right'\n          },\n          children: /*#__PURE__*/_jsx(Button, {\n            neumorphism: true,\n            prefix: /*#__PURE__*/_jsx(Plus, {}),\n            onClick: () => this.setState(state => ({\n              images: [...state.images, '']\n            })),\n            children: \"\\u6DFB\\u52A0\\u8D70\\u9A6C\\u706F\"\n          })\n        })]\n      });\n    });\n\n    const _now = new Date().getTime();\n\n    this.state = {\n      preview: 0,\n      loading: false,\n      submitDisabled: false,\n      draft: '',\n      offset: 0,\n      fontSize: 16,\n      images: [],\n      fullscreen: false,\n      backRender: false,\n      keywords: [],\n      id: '',\n      title: '',\n      url: '',\n      abstract: '',\n      head_image: '',\n      view: 0,\n      publish_time: _now,\n      edit_time: _now,\n      //   published: false,\n      status: 0,\n      raw: '',\n      content: '',\n      tags: [],\n      length: 0\n    };\n  }\n\n  componentDidMount() {\n    var url = this.props.router.query.url;\n    const value = getLocalStorage(`post-${url}`);\n    this.setState({\n      draft: value\n    });\n    if (url != '' && typeof url != 'undefined') this.initial(url, true); // this.ws = new WebSocket(`${window.location.origin.replace('http', 'ws')}/api/markdown/ws`);\n    // this.ws.onclose = this.wsClose;\n    // window.addEventListener('beforeunload', this.wsClose);\n  }\n\n  componentWillUnmount() {// this.wsClose();\n  } //   wsClose = () => {\n  //     console.log('WS close');\n  //     if (!!this.ws) this.ws.close();\n  //     this.ws = undefined;\n  //     window.removeEventListener('beforeunload', this.wsClose);\n  //   };\n\n\n  render() {\n    return /*#__PURE__*/_jsxs(React.Fragment, {\n      children: [/*#__PURE__*/_jsx(Context.Consumer, {\n        children: context => /*#__PURE__*/_jsx(Head, {\n          children: /*#__PURE__*/_jsx(\"title\", {\n            children: `文章编辑|后台|${context.blog_name}`\n          })\n        })\n      }), /*#__PURE__*/_jsx(RenderFixedButton, {\n        preview: this.state.preview,\n        onPreviewClick: preview => {\n          if (preview !== 0) this.renderMarkdown(this.state.raw);\n          this.setState({\n            preview\n          }, () => {\n            if (!!this.editor) this.editor.layout();\n          });\n        },\n        onSubmit: this.submit,\n        submitDisabled: this.state.submitDisabled,\n        onScrollOffset: diff => {\n          this.setState(state => ({\n            offset: state.offset + diff\n          }), () => {\n            if (!!this.editor) this.onScroll(this.editor.getScrollTop(), this.editor.getScrollHeight());\n          });\n        },\n        onFold: () => this.editor.trigger('fold', 'editor.foldAll'),\n        onUnfold: () => this.editor.trigger('unfold', 'editor.unfoldAll'),\n        fullscreen: this.state.fullscreen,\n        onFullScreen: fullscreen => {\n          this.setState({\n            fullscreen\n          }, () => {\n            this.editor.layout();\n          });\n        },\n        style: this.state.fullscreen ? {\n          zIndex: 5\n        } : {},\n        backRender: this.state.backRender,\n        onChangeRender: backRender => this.setState({\n          backRender\n        }, () => {\n          this.renderMarkdown(this.state.raw);\n        })\n      }), /*#__PURE__*/_jsxs(Flex, {\n        direction: \"TB\",\n        fullWidth: true,\n        children: [/*#__PURE__*/_jsx(Card, {\n          neumorphism: true,\n          children: this.renderToolbar()\n        }), /*#__PURE__*/_jsxs(Flex, {\n          wrap: false,\n          direction: this.state.preview === 0 ? 'row' : this.state.preview === 1 ? 'column-reverse' : 'row',\n          style: this.state.fullscreen ? {\n            position: 'absolute',\n            top: 0,\n            bottom: 0,\n            left: 0,\n            right: 0,\n            background: 'var(--background)',\n            width: '100%',\n            zIndex: 4\n          } : {},\n          children: [/*#__PURE__*/_jsx(Flex.Item, {\n            style: {\n              flex: '1',\n              width: this.state.preview === 2 ? '0%' : '100%'\n            },\n            children: /*#__PURE__*/_jsx(Card, {\n              neumorphism: true,\n              className: styles.editor,\n              id: \"editor\",\n              children: /*#__PURE__*/_jsx(RenderEditor, {\n                raw: this.state.raw,\n                fontSize: this.state.fontSize,\n                getRef: ref => {\n                  this.editor = ref;\n                },\n                onChange: () => {\n                  waitUntil('editor-onchange', () => {\n                    const value = this.editor.getValue();\n                    setLocalStorage(`post-${this.props.router.query.url}`, value);\n                    if (this.state.preview !== 0) this.renderMarkdown(value);\n                    this.setState({\n                      raw: value\n                    });\n                  }, 300);\n                },\n                onSave: this.submit,\n                onScoll: e => this.onScroll(e.scrollTop, e.scrollHeight)\n              })\n            })\n          }), this.state.preview !== 0 ? /*#__PURE__*/_jsx(Flex.Item, {\n            style: this.state.preview === 2 ? {\n              flex: '1',\n              width: '0%'\n            } : {\n              width: '100%'\n            },\n            children: this.renderPreview()\n          }) : null]\n        })]\n      })]\n    });\n  }\n\n}\n\n_defineProperty(PostEdit, \"defaultProps\", {});\n\nexport default withRouter(PostEdit);","map":null,"metadata":{},"sourceType":"module"}